---
title: "数据分析进阶技巧:充分利用宽表的多种用途"
date: "2023-07-17"
categories: 
  - "03"
tags: 
  - "大数据分析"
  - "宽表"
  - "数据处理"
  - "数据整合"
  - "数据治理"
  - "数据预处理"
---

## 一、什么是宽表

在进行数据分析时,我们常会听到“宽表”这个词。那么,宽表到底指什么呢?

宽表(Wide Table)与长表(Long Table)相对应,它通过行转列的形式,将多个关联表中的字段聚合到一张表中,使之形成一种扁平化的结构。

具体来说,宽表有以下两个特点:

**将维度数据同事实数据存储在一张表中**

宽表会将事实表和其相关的维度表进行JOIN联接,把原分散的字段聚合到同一张表内。

例如产品销售表包含了地区、产品、时间等维度信息,以及数量、金额等事实。这样查询时就无需进行表关联,所有字段已在一张表内。

**采用列式存储**

宽表会将每个字段及其属性以列的形式存储,不同的属性之间用列进行区分。

例如产品表中,产品ID、产品名称、品牌都作为产品维度的不同列。地区ID和地区名称也是不同的列。

这种列式存储使各字段直接可用,便于分析运算。

综上,宽表实现了事实表和维度表的聚合,以列的形式存储各个字段属性,从而成为一个扁平化的结构,这是它与长表的显著区别。

![ROI2.png](images/1658154211-roi2-png.png)

## 二、宽表的用途

宽表主要有以下五大用途:

- 提升分析查询效率
- 减少数据冗余
- 便于分析建模
- 结果展示更直观
- 计算效率更高

下面我将详细解释宽表在这五个方面的效果。

### (一)提升分析查询效率

相比长表,宽表可以大幅提升分析查询的效率,主要原因有:

**1)避免表关联,减少连接复杂度**

长表结构下,事实表和维度表是分离的。执行查询分析时,需要将事实表先与所需的维度表连接,才能获得完整的字段。这样 Multiple Joins 使查询逻辑复杂。

而宽表直接将所有相关字段聚合在一张表中,查询可以直接在事实表内完成,无需连接,大大减少了表连接的复杂性,也提升了查询效率。

**2)避免跨表计算,减少资源消耗**

长表进行统计等计算时,需要先联接表,再进行聚合运算。这样不仅逻辑复杂,在计算上也需要消耗大量资源进行关联、聚合等操作。

而宽表计算仅在一张表内进行,避免了高成本的跨表计算,资源消耗较小。特别是在大数据量场景下,更能体现出优势。

**3)字段直接可用,无需聚合转换**

宽表中各维度字段以列形式直接暴露,不需要进行聚合才能使用。这简化了准备工作,直接通过SELECT即可获取需要的列进行分析。

相比之下,长表需要先进行GROUP BY等转换才能得到分析所需的视图,增加了准备工作量。

**4)简化分析流程,更快得到insights**

综合上面因素,宽表结构更加简单扁平,减少了表连接、字段聚合等准备工作,直接进行分析运算更加高效。这也使得用户可以更快地进行数据切片、排序、筛选等,得到需要的分析见解。

总之,宽表可以大幅简化分析流程,提高分析工作的整体效率。对需要频繁分析查询的业务,使用宽表可以取得很好效果。

### (二)避免数据冗余

相比长表,宽表可以有效避免数据冗余,主要体现在:

**1)避免重复存储维度详情**

长表中的事实表只存储部分关键字段,针对文本等大字段需要关联维度表获取详情。这在查询时需要重复访问同一维度数据,造成冗余。

而宽表直接将全部维度字段加入事实表,避免重复存储数据。

**2)减少不必要的重复记录**

具有冗余或重复数据的各维表,在加入事实表时,可以将其去除重复后再加入,减少冗余记录。

例如多个事实表都关联同一产品表,通过宽表联接后,产品记录只需存储一次。

**3)优化存储方式**

宽表可以优化存储方式来进一步减少冗余。例如对于大字段,可以只存储一次,其余记录通过引用的方式使用,避免存储多个完整值。

综上,宽表通过联接表格、消除重复记录、优化存储等手段,可以显著减少冗余数据。这不仅可以节省存储空间,还可以进一步提升读取和计算效率。

### (三)便于分析建模

宽表的结构也便于进行各类分析建模,具体优势有:

**1)直接支持透视分析**

宽表中各维度以列形式直接存储,可直接作为透视分析的透视字段使用。不需要进行表连接才能实现类似的效果。

**2)易于构建数据立方**

在进行OLAP分析时,宽表结构也便于快速构建数据立方体。各维度和指标已呈列式存储,直接即可构成星型或雪花模型,然后建立维度层次,实现多维聚合。

**3)支持多种建模方式**

除了传统的星型和雪花模型,宽表也适合构建更灵活的分析模型,如维表模型。由于宽表已经扁平化,构建不同模型的难度大大降低。

**4)方便自定义透视和切片**

宽表各维度列直接暴露,可以自由进行排列组合,定制所需的分析透视角度,构建任意维度组合的透视表。

**5)易于探索多角度分析**

用户可以在宽表上更容易探索数据,从多个维度切片进行what-if分析,发现更多隐藏模式。这对决策支持分析非常关键。

总之,宽表结构减少了准备工作,为构建各类分析模型提供了极大便利。用户也可以更灵活地进行自定义报表、多维分析等,以发现更多价值。

### (四)结果展示更直观

宽表结果更直观易读,也便于技术终端用户解释,主要体现为:

**1)单条记录展示全部视图**

宽表以行展示一条完整记录,一条记录中已包含所有相关字段。这对用户更加友好、直观。

相比之下,长表查询结果需要包含多条记录,往往分散在不同表,理解和阅读难度更大。

**2)无需了解表关联和透视**

宽表可以直接读取,用户无需理解表连接、透视等转换,就可以直接读取结果,十分直观。

**3)便于制作报表**

宽表结果集更容易直接制作成报表和仪表板进行分享。不需要进行额外的数据透视,直接使用宽表即可得到所需的报表视图。

**4)便于结果分享和协作**

宽表结果更易于在技术和业务部门间分享和协作。业务用户不需要理解复杂的技术过程,就可以直接从宽表中取得需要的洞察,无门槛使用。

总之,宽表使分析结果更友好、直观,降低了结果共享和协作的门槛,有利于业务部门直接利用分析结果进行决策。

### (五)计算效率更高

通过单表计算,宽表结构还可以显著提升分析计算的效率,优势体现在:

**1)避免高成本表关联**

长表需要进行关联才能得到完整视图,这需要进行连接、聚合等运算,计算成本极高。

而宽表直接在一张表内计算,效率更高。

**2)减少扫描数据量**

长表计算需扫描事实表和所有维表,数据量大。宽表只需要扫描事实表一次,数据量会少很多。

**3)利用列存储优化编码**

宽表采用列式存储,可以对某些字段使用编码、压缩等优化存储方式,加速读取。

**4)支持向量化计算**

列式存储也更适合利用向量化指令进行算子优化,可以大幅提升计算速度。

**5)便于并行计算**

宽表计算仅在事实表内,易于并行化,分布式计算也更高效。

综合上述因素,宽表计算效率明显优于长表,这在大数据量计算中尤为明显。可以支持更复杂和大规模的分析运算。

![](images/1642754329-1.jpg)

## 三、构建宽表的主要方法

通过上面的分析,我们了解到宽表在数据分析中有非常重要的作用。那么,应该如何构建宽表呢?主要有以下几种方法:

**直接通过联接方式构建** 这是最简单的方法,通过在SQL中写连接查询,直接将所需的事实表和维度表join到一张宽表中。

这种方法便于快速实现,但维护复杂,需要自己维护关联关系。数据量大时查询效率也会成问题。

**ETL工具构建** 可以通过ETL工具设计作业,将分散的表通过连接、聚合等步骤,最终装载到一张宽表中。

ETL工具可以视觉设计工作流,并可以灵活调度、监控运行。也可以实现增量装载。但需要准备结果表。

**OLAP立方自动设计** 若构建OLAP立方体,一些OLAP工具可以直接通过模型设计,自动构建出宽表形式的多维数据集,并管理维度层次等元数据。这种方法可以避免手动关联查询的复杂度。

**数据仓库自动设计** 数据仓库平台也可以在设计星schema或雪花schema时,自动将维表连接生成宽表,管理起来较简单。还可以设定定期重建表以实现增量更新。

**宽表生成工具** 也有一些专门的宽表生成工具,可以通过配置元数据,自动联接表生成宽表格式的输出,并提供定期重建、增量更新等管理功能。

**直接在数据库生成** 一些数据库也提供了直接生成宽表的语法或功能。例如,对于时序数据,可以直接通过Pivot操作生成宽表。

**在分析引擎中转换** 若在分布式分析引擎上进行分析,也可以在作业中通过关联和透视操作,直接将长表转换为宽表格式,避免专门的建模和转换。

**程序编码方式** 也可以通过编程的方式,手动写代码将表进行连接、聚合,最终输出宽表。这样可以完全自定义转换逻辑,但代码量较大。

需要根据业务场景选择合适的方法。优先考虑能够自动生成并便于维护的工具和平台,以减少重复劳动。

## 四、宽表与长表的选择

虽然宽表在分析场景中有诸多优势,但并不是所有场景都适合使用宽表。在不同的业务需求下,仍需要选择使用宽表或长表的不同结构。

主要的选择原则包括:

**数据规模** 数据量非常大的场景,宽表存储和计算成本都很高,此时更适合长表存储,需要时再透视。

**字段聚合度** 字段高度聚合则更适合宽表,字段分散则长表更好。

**查询和分析需求** 需要频繁聚合分析的业务宽表更合适。对原数据查询更多的业务则可采用长表。

**数据更新频率** 数据实时变更较多时,长表的增量更友好。

**模型灵活性** 若需要频繁变更建模方式,长表更具有弹性。

所以,还需要对业务场景进行充分研究,才能对表结构进行合理的设计,在易用性和高效性间做出正确取舍。

## 五、总结

综上所述,宽表通过将分散的字段聚合到同一张表中,采用列式的结构存储,可以大幅简化分析流程,降低冗余,提升分析和计算的效率。它非常适合分析型的应用场景。

但是在具体使用时,还需要平衡业务需求,并与长表形成配合,才能发挥各自的优势。宽表的使用为大数据分析提供了很好的思路,是进行数据汇聚和加速分析的重要手段之一。
